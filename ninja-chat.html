<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study Ninja</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
    }

    .chat-window {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      -webkit-app-region: drag;
      border-bottom: 1px solid #f0f0f0;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-avatar {
      width: 28px;
      height: 28px;
      background: url('mov/cover.png') no-repeat center center;
      background-size: cover;
      border-radius: 50%;
      position: relative;
    }

    .chat-title {
      font-size: 13px;
      font-weight: 700;
      color: #4a4a5a;
    }

    .chat-subtitle {
      font-size: 10px;
      color: #c4b5fd;
    }

    .chat-close {
      -webkit-app-region: no-drag;
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .chat-close:hover { background: #fee2e2; color: #f87171; }

    /* Transcript */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.5;
      animation: msg-in 0.2s ease-out;
    }

    @keyframes msg-in {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg.ninja {
      background: linear-gradient(135deg, #faf5ff, #fce7f3);
      color: #4a4a5a;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .msg.user {
      background: linear-gradient(135deg, #e8a0bf, #c4b5fd);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    /* Voice controls */
    .voice-area {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      border-top: 1px solid #f0f0f0;
    }

    .status-text {
      font-size: 12px;
      color: #999;
    }

    .status-text.active { color: #8b5cf6; }

    .mic-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #e8a0bf, #c4b5fd);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      position: relative;
    }

    .mic-btn:hover { transform: scale(1.05); }

    .mic-btn.listening {
      animation: pulse 1.5s ease-in-out infinite;
      box-shadow: 0 0 0 0 rgba(196, 181, 253, 0.4);
    }

    .mic-btn.speaking {
      background: linear-gradient(135deg, #86efac, #34d399);
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(196, 181, 253, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(196, 181, 253, 0); }
      100% { box-shadow: 0 0 0 0 rgba(196, 181, 253, 0); }
    }

    .mic-btn.disconnected {
      background: #e8e8e8;
      color: #999;
    }

    .end-btn {
      padding: 6px 16px;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      background: white;
      color: #999;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .end-btn:hover { border-color: #f87171; color: #f87171; }

    .connecting-text {
      font-size: 12px;
      color: #c4b5fd;
    }
  </style>
</head>
<body>
  <div class="chat-window">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="chat-avatar"></div>
        <div>
          <div class="chat-title">Bearly</div>
          <div class="chat-subtitle" id="statusLabel">connecting...</div>
        </div>
      </div>
      <button class="chat-close" id="chatClose">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="voice-area">
      <div class="status-text" id="modeText">Connecting...</div>
      <button class="mic-btn disconnected" id="micBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </button>
      <button class="end-btn" id="endBtn">End conversation</button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const { Conversation } = require('@elevenlabs/client');

    const chatMessages = document.getElementById('chatMessages');
    const micBtn = document.getElementById('micBtn');
    const modeText = document.getElementById('modeText');
    const statusLabel = document.getElementById('statusLabel');

    let conversation = null;

    function addMessage(text, sender) {
      // Check if last message is same sender â€” update it instead
      const last = chatMessages.lastElementChild;
      if (last && last.classList.contains(sender) && last.dataset.final !== 'true') {
        last.textContent = text;
      } else {
        const msg = document.createElement('div');
        msg.className = 'msg ' + sender;
        msg.textContent = text;
        chatMessages.appendChild(msg);
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function finalizeLastMessage(sender) {
      const last = chatMessages.lastElementChild;
      if (last && last.classList.contains(sender)) {
        last.dataset.final = 'true';
      }
    }

    async function startConversation() {
      try {
        const signedUrl = await ipcRenderer.invoke('get-signed-url');

        conversation = await Conversation.startSession({
          signedUrl,
          connectionType: 'websocket',

          clientTools: {
            start_pomodoro: async (params) => {
              ipcRenderer.send('voice-start-pomodoro', {
                duration: params.duration || 25,
                breakDuration: params.break_duration || 5,
                reps: params.reps || 4
              });
              return "Pomodoro timer started!";
            },
            stop_pomodoro: async () => {
              ipcRenderer.send('voice-stop-pomodoro');
              return "Timer stopped.";
            },
            add_exam: async (params) => {
              ipcRenderer.send('voice-add-exam', {
                subject: params.subject,
                date: params.date
              });
              return `Exam for ${params.subject} added!`;
            },
            start_quiz: async () => {
              ipcRenderer.send('voice-start-quiz');
              return "Starting a quiz!";
            }
          },

          onConnect: () => {
            statusLabel.textContent = 'voice chat';
            micBtn.classList.remove('disconnected');
            micBtn.classList.add('listening');
            modeText.textContent = 'Listening...';
            ipcRenderer.send('ninja-talking-state', 'listening');
          },

          onDisconnect: () => {
            statusLabel.textContent = 'disconnected';
            micBtn.classList.add('disconnected');
            micBtn.classList.remove('listening', 'speaking');
            modeText.textContent = 'Disconnected';
            ipcRenderer.send('ninja-talking-state', 'idle');
          },

          onMessage: (message) => {
            if (message.source === 'user') {
              if (message.message) {
                addMessage(message.message, 'user');
                if (message.type === 'final') finalizeLastMessage('user');
              }
            } else if (message.source === 'ai') {
              if (message.message) {
                addMessage(message.message, 'ninja');
                if (message.type === 'final') finalizeLastMessage('ninja');
              }
            }
          },

          onModeChange: (mode) => {
            if (mode.mode === 'speaking') {
              micBtn.classList.remove('listening');
              micBtn.classList.add('speaking');
              modeText.textContent = 'Ninja is speaking...';
              ipcRenderer.send('ninja-talking-state', 'speaking');
            } else {
              micBtn.classList.remove('speaking');
              micBtn.classList.add('listening');
              modeText.textContent = 'Listening...';
              ipcRenderer.send('ninja-talking-state', 'listening');
            }
          },

          onError: (error) => {
            console.error('Conversation error:', error);
            modeText.textContent = 'Error occurred';
          },
        });
      } catch (err) {
        console.error('Failed to start conversation:', err);
        modeText.textContent = 'Failed to connect';
        statusLabel.textContent = 'error';
      }
    }

    // End conversation
    document.getElementById('endBtn').addEventListener('click', async () => {
      if (conversation) {
        await conversation.endSession();
        conversation = null;
      }
      ipcRenderer.send('ninja-talking-state', 'idle');
      ipcRenderer.send('close-ninja-chat');
    });

    document.getElementById('chatClose').addEventListener('click', async () => {
      if (conversation) {
        await conversation.endSession();
        conversation = null;
      }
      ipcRenderer.send('ninja-talking-state', 'idle');
      ipcRenderer.send('close-ninja-chat');
    });

    // Start when greeting is received
    ipcRenderer.on('ninja-greeting', () => {
      startConversation();
    });
  </script>
</body>
</html>
