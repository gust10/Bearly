<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reverse Teaching</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      color: #4a4a5a;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      -webkit-app-region: drag;
      border-bottom: 1px solid #f0f0f0;
    }

    .header-title {
      font-size: 13px;
      font-weight: 700;
      color: #e8a0bf;
    }

    .close-btn {
      -webkit-app-region: no-drag;
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .close-btn:hover { background: #fee2e2; color: #f87171; }

    .screen-container {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .screen { display: none; flex-direction: column; height: 100%; }
    .screen.active { display: flex; }

    .screen-title {
      font-size: 13px;
      font-weight: 600;
      color: #7c6a9a;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-family: inherit;
      font-size: 12px;
      resize: none;
      outline: none;
      transition: border-color 0.2s;
    }
    textarea:focus { border-color: #c084fc; }

    .btn-row { display: flex; gap: 8px; margin-top: 10px; }

    .primary-btn {
      background: rgba(232, 160, 191, 0.15);
      color: #8b5cf6;
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
    }
    .primary-btn:hover { background: rgba(232, 160, 191, 0.25); }

    .secondary-btn {
      background: #f8fafc;
      color: #64748b;
      border: 1px solid #e2e8f0;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }
    .secondary-btn:hover { border-color: #c4b5fd; color: #8b5cf6; }

    .back-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      font-weight: 600;
      padding: 0;
      margin-bottom: 12px;
      transition: color 0.2s;
    }
    .back-btn:hover { color: #64748b; }

    /* Feedback area */
    .feedback-box {
      flex: 1;
      background: #faf5ff;
      border: 1px solid #f3e8ff;
      padding: 12px;
      border-radius: 10px;
      font-size: 12px;
      overflow-y: auto;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .msg { padding: 8px 12px; border-radius: 10px; margin-bottom: 6px; font-size: 12px; line-height: 1.5; }
    .msg-user { background: rgba(232, 160, 191, 0.15); color: #4a4a5a; }
    .msg-ai { background: white; border: 1px solid #f0f0f0; color: #4a4a5a; }

    .chat-input-area {
      display: none;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      outline: none;
    }
    .chat-input:focus { border-color: #c4b5fd; }

    .send-btn {
      background: #c4b5fd;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #94a3b8;
      margin: 8px 0;
    }
    .loading-ring { display: inline-flex; width: 16px; height: 16px; position: relative; }
    .loading-ring div {
      box-sizing: border-box;
      display: block;
      position: absolute;
      width: 14px; height: 14px;
      border: 2px solid #c4b5fd;
      border-radius: 50%;
      border-color: #c4b5fd transparent transparent transparent;
      animation: ring 1.2s cubic-bezier(0.5,0,0.5,1) infinite;
    }
    .loading-ring div:nth-child(1) { animation-delay: -0.45s; }
    .loading-ring div:nth-child(2) { animation-delay: -0.3s; }
    .loading-ring div:nth-child(3) { animation-delay: -0.15s; }
    @keyframes ring { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }

    /* Flashcard modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 1000;
      align-items: center; justify-content: center;
    }
    .modal-content {
      background: white; width: 90%; max-width: 320px;
      padding: 20px; border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-input {
      width: 100%; padding: 8px;
      border: 1px solid #e2e8f0; border-radius: 8px;
      font-family: inherit; font-size: 12px; outline: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-title">Reverse Teaching</div>
      <button class="close-btn" id="closeBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <div class="screen-container">
      <!-- Screen 1: Material Input -->
      <div class="screen active" id="topicScreen">
        <div class="screen-title">Paste your study material or upload a PDF:</div>
        <textarea id="topicInput" rows="8" placeholder="Paste your notes, textbook excerpt, or study material here..."></textarea>
        <div class="btn-row">
          <button class="secondary-btn" id="rtUploadPdfBtn">Upload PDF</button>
          <button class="primary-btn" id="submitTopicBtn">Next</button>
        </div>
      </div>

      <!-- Screen 2: Explanation Input -->
      <div class="screen" id="explanationScreen">
        <button class="back-btn" id="backToMaterial">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          Back
        </button>
        <div class="screen-title">Now explain what you understood from the material:</div>
        <textarea id="explanationInput" rows="8" placeholder="Explain the key concepts in your own words..."></textarea>
        <div class="btn-row">
          <button class="primary-btn" id="submitExplanationBtn">Submit</button>
        </div>
      </div>

      <!-- Screen 3: Feedback & Chat -->
      <div class="screen" id="feedbackScreen">
        <button class="back-btn" id="feedbackBackBtn">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          Back
        </button>
        <div id="feedbackContent" class="feedback-box"></div>

        <div id="feedbackLoading" class="loading" style="display: none;">
          <div class="loading-ring"><div></div><div></div><div></div><div></div></div>
          Thinking...
        </div>

        <div class="chat-input-area" id="chatInputArea">
          <input type="text" id="chatInput" class="chat-input" placeholder="Continue the discussion...">
          <button id="sendChatBtn" class="send-btn">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>

        <div class="btn-row" style="margin-top: 4px;">
          <button class="secondary-btn" id="openFcModalBtn">Generate Flashcards</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Flashcard Modal -->
  <div class="modal-overlay" id="flashcardModal" style="display: none;">
    <div class="modal-content">
      <div style="font-size: 14px; font-weight: 800; color: #4a4a5a; margin-bottom: 15px; text-align: center;">Generate Flashcards</div>
      <div style="margin-bottom: 12px;">
        <label style="font-size: 11px; font-weight: 700; color: #94a3b8; display: block; margin-bottom: 4px;">DECK NAME</label>
        <input type="text" id="fcDeckName" class="modal-input" placeholder="e.g. French Verbs">
      </div>
      <div style="margin-bottom: 12px;">
        <label style="font-size: 11px; font-weight: 700; color: #94a3b8; display: block; margin-bottom: 4px;">NUMBER OF CARDS</label>
        <input type="number" id="fcCardCount" value="5" min="1" max="20" class="modal-input">
      </div>
      <div style="margin-bottom: 20px;">
        <label style="font-size: 11px; font-weight: 700; color: #94a3b8; display: block; margin-bottom: 6px;">CONTEXT</label>
        <div style="display: flex; gap: 8px;">
          <button id="ctxRecent" class="ctx-option active" style="flex: 1; padding: 8px; border: 1.5px solid #c4b5fd; border-radius: 8px; background: rgba(196, 181, 253, 0.1); color: #8b5cf6; font-size: 11px; font-weight: 600; cursor: pointer;">Most Recent Message</button>
          <button id="ctxAll" class="ctx-option" style="flex: 1; padding: 8px; border: 1.5px solid #e2e8f0; border-radius: 8px; background: white; color: #64748b; font-size: 11px; font-weight: 600; cursor: pointer;">All Messages</button>
        </div>
      </div>
      <div style="display: flex; gap: 10px;">
        <button id="cancelFcBtn" style="flex: 1; padding: 10px; border: none; border-radius: 8px; background: #f1f5f9; color: #64748b; font-weight: 700; cursor: pointer;">Cancel</button>
        <button id="generateFcBtn" style="flex: 1; padding: 10px; border: none; border-radius: 8px; background: rgba(232, 160, 191, 0.15); color: #8b5cf6; font-weight: 800; cursor: pointer;">Generate</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    const MINIMAX_API_KEY = 'sk-api-PdXV6pPmAj9yASBU2aWZDPz7YMgdPq9r68zUKB-OuiyiRdlVlCsxYxiCw1untrVlMN8ojo4YFyGmyVhuroAJnGFNGAbf_s9clvK3D4MQJv658EdEH3aWsN0';
    let studyMaterial = '';
    let currentTopic = '';
    let chatHistory = [];

    const screens = document.querySelectorAll('.screen');
    const topicInput = document.getElementById('topicInput');
    const explanationInput = document.getElementById('explanationInput');
    const feedbackContent = document.getElementById('feedbackContent');
    const chatInput = document.getElementById('chatInput');
    const chatInputArea = document.getElementById('chatInputArea');
    const feedbackLoading = document.getElementById('feedbackLoading');

    function showScreen(id) {
      screens.forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function saveToMemory() {
      if (chatHistory.length >= 2) {
        const transcript = chatHistory
          .map(m => `${m.role === 'user' ? 'Student' : 'Tutor'}: ${m.content}`)
          .join('\n');
        ipcRenderer.send('save-reverse-teaching-transcript', { transcript, topic: currentTopic });
      }
    }

    function resetAll() {
      topicInput.value = '';
      explanationInput.value = '';
      chatInput.value = '';
      feedbackContent.innerHTML = '';
      chatInputArea.style.display = 'none';
      chatHistory = [];
      studyMaterial = '';
      currentTopic = '';
      showScreen('topicScreen');
    }

    document.getElementById('closeBtn').addEventListener('click', () => {
      saveToMemory();
      resetAll();
      ipcRenderer.send('close-reverse-teaching');
    });

    // Screen 1: submit material
    document.getElementById('submitTopicBtn').addEventListener('click', () => {
      studyMaterial = topicInput.value.trim();
      if (studyMaterial) {
        currentTopic = studyMaterial.split('\n')[0].substring(0, 50);
        ipcRenderer.send('set-study-material', studyMaterial);
        showScreen('explanationScreen');
      }
    });

    document.getElementById('rtUploadPdfBtn').addEventListener('click', async () => {
      const text = await ipcRenderer.invoke('pick-pdf');
      if (text) topicInput.value = text;
    });

    document.getElementById('backToMaterial').addEventListener('click', () => {
      explanationInput.value = '';
      showScreen('topicScreen');
    });

    // Screen 2: submit explanation
    document.getElementById('submitExplanationBtn').addEventListener('click', async () => {
      const explanation = explanationInput.value.trim();
      if (!explanation) return;

      showScreen('feedbackScreen');
      feedbackContent.innerHTML = '';
      chatHistory = [{ role: 'user', content: `My explanation of the material:\n${explanation}` }];

      ipcRenderer.send('save-study-event', {
        source: 'reverse_teaching',
        topics: [currentTopic],
        summary: `Practiced explaining "${currentTopic}" via reverse teaching`
      });

      await callMinimax();
    });

    // Screen 3: feedback chat
    document.getElementById('feedbackBackBtn').addEventListener('click', () => {
      saveToMemory();
      feedbackContent.innerHTML = '';
      chatInput.value = '';
      chatInputArea.style.display = 'none';
      chatHistory = [];
      showScreen('explanationScreen');
    });

    document.getElementById('sendChatBtn').addEventListener('click', async () => {
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = '';
      chatHistory.push({ role: 'user', content: text });
      appendMessage('user', text);
      await callMinimax();
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('sendChatBtn').click();
    });

    function appendMessage(role, text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `msg msg-${role === 'user' ? 'user' : 'ai'}`;
      msgDiv.textContent = text;
      feedbackContent.appendChild(msgDiv);
      feedbackContent.scrollTop = feedbackContent.scrollHeight;
    }

    function filterResponse(text) {
      return text.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
    }

    async function callMinimax() {
      feedbackLoading.style.display = 'flex';
      try {
        const response = await fetch('https://api.minimax.io/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${MINIMAX_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'MiniMax-M2.1-highspeed',
            messages: [
              {
                role: 'system',
                content: `You are evaluating a student's understanding of study material. Compare their explanation against the original source material provided below. If the explanation is mostly correct, respond supportively. If they missed critical information or made errors, point out what they missed and explain the correct concepts. Keep your tone friendly and encouraging. Ask if they want to discuss further or try explaining another part. IMPORTANT: OUTPUT ONLY THE DIRECT RESPONSE. NO <think> TAGS OR METADATA. KEEP RESPONSES BRIEF.\n\n--- ORIGINAL STUDY MATERIAL ---\n${studyMaterial.substring(0, 4000)}\n--- END MATERIAL ---`
              },
              ...chatHistory
            ]
          })
        });

        feedbackLoading.style.display = 'none';

        if (!response.ok) {
          const errorText = await response.text();
          appendMessage('ai', `API Error (${response.status}): ${errorText.substring(0, 100)}...`);
          return;
        }

        const data = await response.json();
        if (data.choices && data.choices[0] && data.choices[0].message) {
          const cleanedText = filterResponse(data.choices[0].message.content);
          chatHistory.push({ role: 'assistant', content: cleanedText });
          appendMessage('ai', cleanedText);
          chatInputArea.style.display = 'flex';
        } else {
          appendMessage('ai', 'Error: Unexpected response format.');
        }
      } catch (error) {
        feedbackLoading.style.display = 'none';
        appendMessage('ai', 'Connection error. Please try again.');
        console.error(error);
      }
    }

    // Flashcard modal
    const fcModal = document.getElementById('flashcardModal');
    let fcContextMode = 'recent'; // 'recent' or 'all'

    const ctxRecent = document.getElementById('ctxRecent');
    const ctxAll = document.getElementById('ctxAll');

    function setContextMode(mode) {
      fcContextMode = mode;
      if (mode === 'recent') {
        ctxRecent.style.borderColor = '#c4b5fd';
        ctxRecent.style.background = 'rgba(196, 181, 253, 0.1)';
        ctxRecent.style.color = '#8b5cf6';
        ctxAll.style.borderColor = '#e2e8f0';
        ctxAll.style.background = 'white';
        ctxAll.style.color = '#64748b';
      } else {
        ctxAll.style.borderColor = '#c4b5fd';
        ctxAll.style.background = 'rgba(196, 181, 253, 0.1)';
        ctxAll.style.color = '#8b5cf6';
        ctxRecent.style.borderColor = '#e2e8f0';
        ctxRecent.style.background = 'white';
        ctxRecent.style.color = '#64748b';
      }
    }

    ctxRecent.addEventListener('click', () => setContextMode('recent'));
    ctxAll.addEventListener('click', () => setContextMode('all'));

    document.getElementById('openFcModalBtn').addEventListener('click', () => {
      setContextMode('recent');
      fcModal.style.display = 'flex';
    });

    document.getElementById('cancelFcBtn').addEventListener('click', () => { fcModal.style.display = 'none'; });

    document.getElementById('generateFcBtn').addEventListener('click', async () => {
      const deckName = document.getElementById('fcDeckName').value.trim() || 'Study Session';
      const cardCount = parseInt(document.getElementById('fcCardCount').value) || 5;

      const messages = fcContextMode === 'recent' ? chatHistory.slice(-2) : chatHistory;
      const transcript = messages
        .map(m => `${m.role === 'user' ? 'Student' : 'Tutor'}: ${m.content}`)
        .join('\n');

      const btn = document.getElementById('generateFcBtn');
      btn.disabled = true;
      btn.textContent = 'Generating...';

      const result = await ipcRenderer.invoke('generate-flashcards', { deckName, cardCount, transcript });

      btn.disabled = false;
      btn.textContent = 'Generate';

      if (result.success) {
        alert(`Generated ${result.addedCount} cards for "${deckName}"!`);
        fcModal.style.display = 'none';
        ipcRenderer.send('open-flashcards-viewer');
      } else {
        alert('Generation failed: ' + result.error);
      }
    });
  </script>
</body>
</html>
