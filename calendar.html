<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Calendar</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      user-select: none;
      overflow: hidden;
    }
    .container {
      background: rgba(255,255,255,0.97);
      border-radius: 16px;
      padding: 16px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .header h2 {
      font-size: 15px;
      color: #4a4a5a;
      font-weight: 700;
    }
    .close-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #aaa;
      width: 22px;
      height: 22px;
      padding: 0;
      -webkit-app-region: no-drag;
    }
    .close-btn:hover { color: #e74c3c; }

    /* Month navigation */
    .month-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .month-nav button {
      background: none;
      border: none;
      cursor: pointer;
      color: #8b5cf6;
      font-size: 18px;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .month-nav button:hover { background: #f3f0ff; }
    .month-label {
      font-size: 14px;
      font-weight: 600;
      color: #4a4a5a;
    }

    /* Calendar grid */
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 4px;
    }
    .weekdays span {
      font-size: 10px;
      color: #aaa;
      font-weight: 600;
      text-transform: uppercase;
    }
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      flex: 1;
    }
    .day {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 4px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      color: #4a4a5a;
      position: relative;
      min-height: 36px;
    }
    .day:hover { background: #f9f5ff; }
    .day.today {
      font-weight: 700;
      color: #8b5cf6;
    }
    .day.other-month { color: #d0d0d0; }
    .day .dots {
      display: flex;
      gap: 2px;
      margin-top: 2px;
    }
    .day .dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }
    .dot.exam { background: #e74c3c; }
    .dot.review { background: #8b5cf6; }

    /* Add exam form */
    .add-section {
      border-top: 1px solid #f0ecf9;
      padding-top: 10px;
      margin-top: 8px;
    }
    .add-btn {
      width: 100%;
      padding: 8px;
      background: rgba(232, 160, 191, 0.15);
      color: #8b5cf6;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .add-btn:hover { background: rgba(232, 160, 191, 0.25); }

    .add-form {
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .add-form.visible { display: flex; }
    .add-form input {
      padding: 8px 10px;
      border: 1.5px solid #ede9fe;
      border-radius: 8px;
      font-size: 12px;
      outline: none;
      color: #4a4a5a;
    }
    .add-form input:focus { border-color: #c4b5fd; }
    .form-row {
      display: flex;
      gap: 6px;
    }
    .form-row button {
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .save-btn {
      background: rgba(232, 160, 191, 0.15);
      color: #8b5cf6;
      flex: 1;
    }
    .cancel-btn {
      background: #f0ecf9;
      color: #8b5cf6;
    }

    /* Exam detail popup */
    .exam-detail {
      display: none;
      background: #faf8ff;
      border: 1.5px solid #ede9fe;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 8px;
    }
    .exam-detail.visible { display: block; }
    .exam-detail .exam-subject {
      font-size: 13px;
      font-weight: 600;
      color: #4a4a5a;
    }
    .exam-detail .exam-date-info {
      font-size: 11px;
      color: #8b5cf6;
      margin-top: 2px;
    }
    .exam-detail .exam-reviews {
      font-size: 10px;
      color: #999;
      margin-top: 6px;
    }
    .exam-detail .delete-exam {
      margin-top: 8px;
      background: #fee2e2;
      color: #e74c3c;
      border: none;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      font-weight: 600;
    }
    .exam-detail .delete-exam:hover { background: #fecaca; }

    /* Legend */
    .legend {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 6px;
      font-size: 10px;
      color: #999;
    }
    .legend span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Exam Calendar</h2>
      <button class="close-btn" id="closeBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <div class="month-nav">
      <button id="prevMonth">&#8249;</button>
      <span class="month-label" id="monthLabel"></span>
      <button id="nextMonth">&#8250;</button>
    </div>

    <div class="weekdays">
      <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
    </div>

    <div class="days" id="daysGrid"></div>

    <div class="legend">
      <span><div class="dot exam" style="width:8px;height:8px;border-radius:50%;display:inline-block"></div> Exam</span>
      <span><div class="dot review" style="width:8px;height:8px;border-radius:50%;display:inline-block"></div> Review</span>
    </div>

    <div class="exam-detail" id="examDetail">
      <div class="exam-subject" id="detailSubject"></div>
      <div class="exam-date-info" id="detailDate"></div>
      <div class="exam-reviews" id="detailReviews"></div>
      <button class="delete-exam" id="deleteExamBtn">Delete Exam</button>
    </div>

    <div class="add-section">
      <button class="add-btn" id="addExamBtn">+ Add Exam</button>
      <div class="add-form" id="addForm">
        <input type="text" id="examSubject" placeholder="Subject (e.g. Biology)">
        <input type="date" id="examDate">
        <div class="form-row">
          <button class="save-btn" id="saveExamBtn">Save</button>
          <button class="cancel-btn" id="cancelFormBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let exams = [];
    let selectedExamId = null;

    const REVIEW_OFFSETS = [14, 7, 3, 1]; // days before exam

    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    // Elements
    const daysGrid = document.getElementById('daysGrid');
    const monthLabel = document.getElementById('monthLabel');
    const addForm = document.getElementById('addForm');
    const addExamBtn = document.getElementById('addExamBtn');
    const examDetail = document.getElementById('examDetail');

    // Load exams from main process
    ipcRenderer.invoke('get-exams').then(data => {
      exams = data || [];
      renderCalendar();
    });

    function getReviewDates(examDateStr) {
      const dates = [];
      const examDate = new Date(examDateStr + 'T00:00:00');
      REVIEW_OFFSETS.forEach(offset => {
        const d = new Date(examDate);
        d.setDate(d.getDate() - offset);
        dates.push(formatDate(d));
      });
      return dates;
    }

    function formatDate(d) {
      return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0');
    }

    function renderCalendar() {
      monthLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      daysGrid.innerHTML = '';

      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysInPrev = new Date(currentYear, currentMonth, 0).getDate();

      const today = formatDate(new Date());

      // Build sets of exam dates and review dates
      const examDates = new Map(); // date -> [exam]
      const reviewDates = new Set();

      exams.forEach(exam => {
        if (!examDates.has(exam.date)) examDates.set(exam.date, []);
        examDates.get(exam.date).push(exam);
        getReviewDates(exam.date).forEach(rd => reviewDates.add(rd));
      });

      // Previous month fill
      for (let i = firstDay - 1; i >= 0; i--) {
        const dayNum = daysInPrev - i;
        const div = createDayEl(dayNum, true, null);
        daysGrid.appendChild(div);
      }

      // Current month days
      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = formatDate(new Date(currentYear, currentMonth, d));
        const isToday = dateStr === today;
        const hasExam = examDates.has(dateStr);
        const hasReview = reviewDates.has(dateStr);

        const div = createDayEl(d, false, dateStr);
        if (isToday) div.classList.add('today');

        const dotsDiv = document.createElement('div');
        dotsDiv.className = 'dots';
        if (hasExam) {
          const dot = document.createElement('div');
          dot.className = 'dot exam';
          dotsDiv.appendChild(dot);
        }
        if (hasReview) {
          const dot = document.createElement('div');
          dot.className = 'dot review';
          dotsDiv.appendChild(dot);
        }
        div.appendChild(dotsDiv);

        if (hasExam) {
          div.addEventListener('click', () => showExamDetail(examDates.get(dateStr)[0]));
        }

        daysGrid.appendChild(div);
      }

      // Next month fill
      const totalCells = firstDay + daysInMonth;
      const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remaining; i++) {
        const div = createDayEl(i, true, null);
        daysGrid.appendChild(div);
      }
    }

    function createDayEl(num, isOther, dateStr) {
      const div = document.createElement('div');
      div.className = 'day' + (isOther ? ' other-month' : '');
      const span = document.createElement('span');
      span.textContent = num;
      div.appendChild(span);
      return div;
    }

    function showExamDetail(exam) {
      selectedExamId = exam.id;
      document.getElementById('detailSubject').textContent = exam.subject;

      const examDate = new Date(exam.date + 'T00:00:00');
      const daysUntil = Math.ceil((examDate - new Date().setHours(0,0,0,0)) / (1000*60*60*24));
      let dateInfo = examDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      if (daysUntil > 0) dateInfo += ` (${daysUntil} day${daysUntil !== 1 ? 's' : ''} away)`;
      else if (daysUntil === 0) dateInfo += ' (Today!)';
      else dateInfo += ' (Passed)';
      document.getElementById('detailDate').textContent = dateInfo;

      const reviews = getReviewDates(exam.date).map(rd => {
        const d = new Date(rd + 'T00:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      document.getElementById('detailReviews').textContent = 'Review dates: ' + reviews.join(', ');

      examDetail.classList.add('visible');
      addForm.classList.remove('visible');
      addExamBtn.style.display = 'block';
    }

    // Navigation
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
      examDetail.classList.remove('visible');
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
      examDetail.classList.remove('visible');
    });

    // Add exam
    addExamBtn.addEventListener('click', () => {
      addForm.classList.add('visible');
      addExamBtn.style.display = 'none';
      examDetail.classList.remove('visible');
      document.getElementById('examSubject').value = '';
      document.getElementById('examDate').value = '';
    });

    document.getElementById('cancelFormBtn').addEventListener('click', () => {
      addForm.classList.remove('visible');
      addExamBtn.style.display = 'block';
    });

    document.getElementById('saveExamBtn').addEventListener('click', () => {
      const subject = document.getElementById('examSubject').value.trim();
      const date = document.getElementById('examDate').value;
      if (!subject || !date) return;

      const exam = { id: Date.now().toString(), subject, date };
      exams.push(exam);
      ipcRenderer.send('save-exams', exams);

      addForm.classList.remove('visible');
      addExamBtn.style.display = 'block';
      renderCalendar();
    });

    // Delete exam
    document.getElementById('deleteExamBtn').addEventListener('click', () => {
      if (!selectedExamId) return;
      exams = exams.filter(e => e.id !== selectedExamId);
      ipcRenderer.send('save-exams', exams);
      selectedExamId = null;
      examDetail.classList.remove('visible');
      renderCalendar();
    });

    // Close
    document.getElementById('closeBtn').addEventListener('click', () => {
      ipcRenderer.send('close-calendar');
    });

    renderCalendar();
  </script>
</body>
</html>
