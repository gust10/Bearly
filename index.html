<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Studyyyy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      color: #4a4a5a;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: rgba(255, 255, 255, 0.97);
      border-right: 1px solid #eee;
      border-radius: 0;
      overflow: hidden;
      transition: opacity 0.3s;
    }

    /* Peek line visible when hidden */
    .peek-line {
      position: fixed;
      top: 0;
      right: 0;
      width: 6px;
      height: 100%;
      background: linear-gradient(180deg, #e8a0bf 0%, #c4b5fd 50%, #e8a0bf 100%);
      border-radius: 0 3px 3px 0;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .peek-line.visible {
      opacity: 1;
    }

    .titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      -webkit-app-region: drag;
      border-bottom: 1px solid #f0f0f0;
    }

    .titlebar h2 {
      font-size: 14px;
      font-weight: 700;
      color: #e8a0bf;
      letter-spacing: 0.5px;
    }

    .close-btn {
      -webkit-app-region: no-drag;
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: #fee2e2;
      color: #f87171;
    }

    .nav {
      display: flex;
      flex-direction: column;
      padding: 8px 8px;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      cursor: pointer;
      border: none;
      background: none;
      color: #999;
      font-size: 13px;
      font-weight: 500;
      width: 100%;
      text-align: left;
      border-radius: 10px;
      transition: all 0.2s;
    }

    .nav-item:hover {
      background: #faf5ff;
      color: #7c6a9a;
    }

    .nav-item.active {
      background: linear-gradient(135deg, #fce7f3, #ede9fe);
      color: #8b5cf6;
    }

    .nav-item svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .nav-item.active svg {
      stroke: #c084fc;
    }

    /* Reverse Teaching Styles */
    #mainContent {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .screen {
      display: none;
      flex-direction: column;
      padding: 12px;
      gap: 10px;
      height: 100%;
      animation: fadeIn 0.3s ease-in-out;
    }

    .screen.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .screen-title {
      font-size: 13px;
      font-weight: 600;
      color: #7c6a9a;
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    textarea, input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 8px;
      font-family: inherit;
      font-size: 12px;
      resize: none;
      outline: none;
      transition: border-color 0.2s;
    }

    textarea {
      height: 80px;
    }

    textarea:focus, input[type="text"]:focus {
      border-color: #c084fc;
    }

    .primary-btn {
      background: linear-gradient(135deg, #e8a0bf, #c4b5fd);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .primary-btn:hover {
      opacity: 0.9;
    }

    .secondary-btn {
      background: #f8fafc;
      color: #64748b;
      border: 1px solid #e2e8f0;
      padding: 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
    }

    .feedback-box {
      background: #faf5ff;
      border: 1px solid #f3e8ff;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.5;
      color: #5b21b6;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 5px;
    }

    .msg {
      padding: 8px;
      border-radius: 6px;
      max-width: 90%;
    }

    .msg-user {
      align-self: flex-end;
      background: #fdf2f8;
      color: #be185d;
      border: 1px solid #fce7f3;
    }

    .msg-ai {
      align-self: flex-start;
      background: #f5f3ff;
      color: #5b21b6;
      border: 1px solid #ede9fe;
    }

    .chat-input-area {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .chat-input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 11px;
      outline: none;
    }

    .send-btn {
      background: #c4b5fd;
      color: white;
      border: none;
      padding: 0 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      font-size: 12px;
      color: #999;
      padding-right: 10px;
    }

    .dot-flashing {
      position: relative;
      width: 6px;
      height: 6px;
      border-radius: 3px;
      background-color: #c084fc;
      color: #c084fc;
      animation: dot-flashing 1s infinite linear alternate;
      animation-delay: 0.5s;
    }
    .dot-flashing::before, .dot-flashing::after {
      content: "";
      display: inline-block;
      position: absolute;
      top: 0;
    }
    .dot-flashing::before {
      left: -15px;
      width: 6px;
      height: 6px;
      border-radius: 3px;
      background-color: #c084fc;
      color: #c084fc;
      animation: dot-flashing 1s infinite alternate;
      animation-delay: 0s;
    }
    .dot-flashing::after {
      left: 15px;
      width: 6px;
      height: 6px;
      border-radius: 3px;
      background-color: #c084fc;
      color: #c084fc;
      animation: dot-flashing 1s infinite alternate;
      animation-delay: 1s;
    }

    @keyframes dot-flashing {
      0% { background-color: #c084fc; }
      50%, 100% { background-color: rgba(192, 132, 252, 0.2); }
    }

    .back-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }

    .back-btn svg {
      width: 14px;
      height: 14px;
    }
  </style>
</head>
<body>
  <div class="peek-line" id="peekLine"></div>
  <div class="app" id="appPanel">
    <div class="titlebar">
      <h2>studyyyy</h2>
      <button class="close-btn" id="closeBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <nav class="nav" id="mainNav">
      <button class="nav-item active" data-tab="pomodoro">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Pomodoro
      </button>
      <button class="nav-item" data-tab="active-recall">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z"/><line x1="9" y1="21" x2="15" y2="21"/></svg>
        Active Recall
      </button>
      <button class="nav-item" data-tab="reverse-teaching" id="reverseTeachingBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        Reverse Teaching
      </button>
      <button class="nav-item" data-tab="flashcards">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        Flashcards
      </button>
    </nav>

    <div id="mainContent">
      <!-- Screen 1: Topic Input -->
      <div class="screen" id="topicScreen">
        <button class="back-btn" onclick="showNav()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg> Back
        </button>
        <div class="screen-title" style="margin-top: 15px;">Please enter the topic you would like to explain:</div>
        <div class="input-group">
          <input type="text" id="topicInput" placeholder="e.g. Photosynthesis">
          <button class="primary-btn" id="submitTopicBtn">Next</button>
        </div>
      </div>

      <!-- Screen 2: Explanation Input -->
      <div class="screen" id="explanationScreen">
        <button class="back-btn" onclick="showScreen('topicScreen')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg> Back
        </button>
        <div class="screen-title" style="margin-top: 15px;">Now, please explain everything you know about this topic:</div>
        <div class="input-group">
          <textarea id="explanationInput" rows="5" placeholder="Your explanation..."></textarea>
          <button class="primary-btn" id="submitExplanationBtn">Submit</button>
        </div>
      </div>

      <!-- Screen 3: Feedback & Chat -->
      <div class="screen" id="feedbackScreen">
        <button class="back-btn" id="feedbackBackBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg> Back
        </button>
        <div class="screen-title" style="margin-top: 15px;">Reverse Teaching Feedback</div>
        <div id="feedbackContent" class="feedback-box"></div>
        
        <div id="feedbackLoading" class="loading" style="display: none; margin: 5px 0;">
          <div class="dot-flashing"></div>
          Thinking...
        </div>

        <div class="chat-input-area" id="chatInputArea" style="display: none;">
          <input type="text" id="chatInput" class="chat-input" placeholder="Continue the discussion...">
          <button id="sendChatBtn" class="send-btn">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>

        <div class="input-group" style="padding-top: 8px; padding-bottom: 6px;">
          <button class="secondary-btn" title="Coming Soon">Generate Flashcards</button>
          <button class="secondary-btn" title="Coming Soon">Generate Questions</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const appPanel = document.getElementById('appPanel');
    const peekLine = document.getElementById('peekLine');

    // Close button
    document.getElementById('closeBtn').addEventListener('click', () => {
      window.close();
    });

    // Tab navigation logic
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const tab = item.getAttribute('data-tab');
        if (tab === 'reverse-teaching') {
          showScreen('topicScreen');
        } else {
          showNav();
          navItems.forEach(n => n.classList.remove('active'));
          item.classList.add('active');
        }
      });
    });

    // Reverse Teaching Logic
    const MINIMAX_API_KEY = 'sk-api-PdXV6pPmAj9yASBU2aWZDPz7YMgdPq9r68zUKB-OuiyiRdlVlCsxYxiCw1untrVlMN8ojo4YFyGmyVhuroAJnGFNGAbf_s9clvK3D4MQJv658EdEH3aWsN0';
    let currentTopic = '';
    let chatHistory = [];

    function showScreen(screenId) {
      document.getElementById('mainNav').style.display = 'none';
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      if (screenId !== 'feedbackScreen') {
        ipcRenderer.send('set-window-height', 250);
      } else {
        ipcRenderer.send('set-window-height', 400);
      }
    }
    
    function showNav() {
      document.getElementById('mainNav').style.display = 'flex';
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('chatInputArea').style.display = 'none';
      ipcRenderer.send('set-window-height', 250);
    }

    function appendMessage(role, text) {
      const box = document.getElementById('feedbackContent');
      const msgDiv = document.createElement('div');
      msgDiv.className = `msg msg-${role === 'user' ? 'user' : 'ai'}`;
      msgDiv.textContent = text;
      box.appendChild(msgDiv);
      box.scrollTop = box.scrollHeight;
      
      // Resize window
      setTimeout(() => {
        const contentHeight = document.getElementById('appPanel').scrollHeight;
        const newHeight = Math.min(600, Math.max(250, contentHeight + 20));
        ipcRenderer.send('set-window-height', newHeight);
      }, 50);
    }

    function filterResponse(text) {
      // Remove <think> tags and contents if present
      return text.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
    }

    document.getElementById('submitTopicBtn').addEventListener('click', () => {
      currentTopic = document.getElementById('topicInput').value.trim();
      if (currentTopic) {
        showScreen('explanationScreen');
      }
    });

    async function callMinimax() {
      const loading = document.getElementById('feedbackLoading');
      loading.style.display = 'flex';

      try {
        const response = await fetch('https://api.minimax.io/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${MINIMAX_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'MiniMax-M2.1-highspeed',
            messages: [
              {
                role: 'system',
                content: "Evaluate the user's explanation of the topic they provided. If the explanation is mostly correct or close to being correct, respond in a supportive tone without giving lengthy feedback. Only provide detailed feedback if the userâ€™s answer is missing critical information or if their explanation contains major errors. At the end of your response, ask the user if they would like to continue discussing the current topic or if they would prefer to explore a new topic. Be sure to keep your tone friendly, supportive, and encouraging, even when pointing out areas for improvement. IMPORTANT: OUTPUT ONLY THE DIRECT RESPONSE. DO NOT INCLUDE <think> TAGS, XML TAGS, INTERNAL THOUGHTS, OR ANY METADATA. GENERALLY KEEP RESPONSES BRIEF."
              },
              ...chatHistory
            ]
          })
        });

        loading.style.display = 'none';

        if (!response.ok) {
          const errorText = await response.text();
          appendMessage('ai', `API Error (${response.status}): ${errorText.substring(0, 100)}...`);
          return;
        }

        const data = await response.json();
        if (data.choices && data.choices[0] && data.choices[0].message) {
          const fullText = data.choices[0].message.content;
          const cleanedText = filterResponse(fullText);
          
          chatHistory.push({ role: 'assistant', content: cleanedText });
          appendMessage('ai', cleanedText);
          
          // Show chat input after first feedback
          document.getElementById('chatInputArea').style.display = 'flex';
        } else {
          appendMessage('ai', "Error: Unexpected response format.");
        }
      } catch (error) {
        loading.style.display = 'none';
        appendMessage('ai', "Connection error. Please try again.");
        console.error(error);
      }
    }

    document.getElementById('submitExplanationBtn').addEventListener('click', async () => {
      const explanation = document.getElementById('explanationInput').value.trim();
      if (!explanation) return;

      showScreen('feedbackScreen');
      document.getElementById('feedbackContent').innerHTML = '';
      chatHistory = [{ role: 'user', content: `Topic: ${currentTopic}\nExplanation: ${explanation}` }];
      
      await callMinimax();
    });

    document.getElementById('sendChatBtn').addEventListener('click', async () => {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;

      input.value = '';
      chatHistory.push({ role: 'user', content: text });
      appendMessage('user', text);
      
      await callMinimax();
    });

    // Also send on Enter key
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('sendChatBtn').click();
    });

    document.getElementById('feedbackBackBtn').addEventListener('click', () => {
      showScreen('explanationScreen');
    });

    // Mouse enter/leave for auto-hide
    document.body.addEventListener('mouseenter', () => {
      ipcRenderer.send('mouse-enter');
    });

    document.body.addEventListener('mouseleave', () => {
      ipcRenderer.send('mouse-leave');
    });

    // Show/hide peek line
    ipcRenderer.on('hidden-state', (event, isHidden) => {
      if (isHidden) {
        peekLine.classList.add('visible');
        appPanel.style.opacity = '0';
      } else {
        peekLine.classList.remove('visible');
        appPanel.style.opacity = '1';
      }
    });
  </script>
</body>
</html>
